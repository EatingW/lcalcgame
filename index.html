<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>That programming game</title>

        <!-- Third-party dependencies -->
        <script src="lib/FileSaver.min.js" charset="utf-8"></script>
        <!-- Write a level modal popover -->
        <link rel="stylesheet" href="lib/jquery-ui.min.css" media="screen" charset="utf-8">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
        <script src="lib/jquery-ui.min.js" charset="utf-8"></script>
        <script src="lib/jquery-ui.structure.min.css" charset="utf-8"></script>
        <script src="lib/writeALevelPopup.js"></script>

        <!-- Game dependencies -->
        <script src="build/logger.js" charset="utf-8"></script>
        <script src="build/util.js" charset="utf-8"></script>
        <script src="build/vis.js" charset="utf-8"></script>
        <script src="build/structs.js" charset="utf-8"></script>
        <script src="build/lambda.js" charset="utf-8"></script>
        <script src="build/lambda_expr.js" charset="utf-8"></script>
        <script src="build/funcs.js" charset="utf-8"></script>
        <script src="build/concrete_faded_exprs.js" charset="utf-8"></script>
        <script src="build/event.js" charset="utf-8"></script>
        <script src="build/game.js" charset="utf-8"></script>
        <script src="build/animate.js" charset="utf-8"></script>
        <script src="build/image.js" charset="utf-8"></script>
        <script src="build/toolbox.js" charset="utf-8"></script>
        <script src="build/resource.js" charset="utf-8"></script>
        <script src="build/effect.js" charset="utf-8"></script>
        <style media="screen">
            #canvas {
                padding: 0;
                margin-left: auto;
                margin-right: auto;
                display: block;
            }
            .centered {
                padding: 0;
                margin-left: auto;
                margin-right: auto;
                width: 100%;
                display: block;
                text-align: center;
            }
            .expr_input {
                font-family: Consolas, sans-serif;
            }
        </style>
        <script type="text/javascript">

        var GLOBAL_DEFAULT_CTX = null;
        var GLOBAL_DEFAULT_SCREENSIZE = null;
        var stage;
        var canvas;
        var level_idx = 0;
        function init() {

            setWriteALevelPopup("writeALevel", 'write-level-form');

            if (__GET_PARAMS) {
                var start_from = __GET_PARAMS.level;
                var faded_lambdas = __GET_PARAMS.faded;
                if (start_from) {
                    console.log(start_from);
                    level_idx = parseInt(start_from);
                }
                if (faded_lambdas && faded_lambdas.toLowerCase() === 'true') {
                    __FADED_LAMBDAS = true;
                } else __FADED_LAMBDAS = false;

                __FADED_FUNCS = false;
            }

            // Start a new log session (creating userID as necessary),
            // and then begin the game.
            Logger.startSession().then((userinfo) => {
                return loadChapterSelect();
            }).then(initBoard);
        }

        function loadCustomLevel(lvl_desc, goal_desc) {
            stage = Resource.buildLevel( [lvl_desc, goal_desc], canvas );
            stage.update();
            stage.draw();
        }

        function initBoard() {

            canvas = document.getElementById('canvas');
            if (canvas.getContext) {

                if (stage) {
                    stage.invalidate();
                    delete stage;
                }

                if(AnimationUpdateLoop) AnimationUpdateLoop.clear();

                GLOBAL_DEFAULT_CTX = canvas.getContext('2d');
                GLOBAL_DEFAULT_SCREENSIZE = canvas.getBoundingClientRect();
                document.getElementById('lvl_num').innerHTML = level_idx + '';
                document.getElementById('lvl_desc').innerHTML = Resource.level[level_idx].description || '(No description.)';

                stage = Resource.buildLevel(Resource.level[level_idx], canvas);

                Logger.transitionToTask(level_idx, stage.toString()).catch((err) => {
                    //console.error(err);
                });

                stage.update();
                stage.draw();

                // This fixes some render bugs. Not exactly sure why.
                stage.draw();
            }
        }
        function prev() {
            if (!Logger.sessionBegan()) return;
            if (level_idx === 0) initBoard();
            else {
                level_idx--;
                initBoard();
            }
        }
        function next() {
            if (!Logger.sessionBegan()) return;
            if (level_idx === Resource.level.length-1) initBoard();
            else {
                level_idx++;
                initBoard();
            }
        }
        function undo() {
            if (!Logger.sessionBegan()) return;
            stage.restoreState();
        }

        function loadChapterSelect() {
            var sel = document.getElementById("chapterSelect");
            removeOptions(sel); // clear old options.
            return Resource.getChapters().then( function(chapters) {
                chapters.forEach(function (chap) {
                    console.error('chapter', chap.name);
                    var option = document.createElement("option");
                    option.text = chap.description;
                    option.value = chap.name;
                    sel.add(option);
                });
                return new Promise(function(resolve, reject) {
                    resolve();
                });
            } );
        }
        function gotoChapter() {
            var sel = document.getElementById('chapterSelect');
            var selected_chapter = sel.options[sel.selectedIndex].value;
            level_idx = Resource.getChapter(selected_chapter).startIdx;
            initBoard();
        }

        </script>
    </head>
    <body onload="init()" bgcolor="lightgray">
        <canvas id="canvas" onmousedown="" width="800" height="600" style="background-color:#EEE;"></canvas>
        <br />
        <div id="state" class="centered">
            <button onclick="undo()">Undo</button>
        </div>
        <div id="explanation" class="centered">
            <button onclick="prev()">Prev</button>
            <button onclick="initBoard()">Reset</button>
            <button onclick="next()">Next</button>
            <p>
                Level #<span id="lvl_num"></span> <br />
                <span style="color:grey;"><span id="lvl_desc">[description]</span></span> <br />
                Jump to: <select id="chapterSelect" name="chapter" onchange="gotoChapter()">
                </select>
            </p>
            <p>
                Drop expressions into <span style="color:#666;">holes</span> inside other expressions. <br />
                If an expression blinks <span style="color:ForestGreen;">green</span>, click it to reduce.
            </p>
        </div>
        <div class="centered">
            <p>
                <button id="writeALevel">Write your own level!</button>
            </p>

            <div id="write-level-form" title="Write a level">
              <p class="validateTips">Refer to <a href="writing_levels.html" target="blank">this sheet</a> for more info.</p>

              <form>
                <fieldset>
                  <label for="name">Level:</label>
                  <input type="text" name="name" id="level_expr_input" value="(Î»x #x) (star)" class="expr_input" size="45"> <br />
                  <label for="email">Goal:</label>
                  <input type="text" name="email" id="goal_expr_input" value="(star)" class="expr_input" size="45">

                  <!-- Allow form submission with keyboard without duplicating the dialog button -->
                  <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
                </fieldset>
              </form>

              <p>
                  Or upload a JSON spec for a new chapter:
              </p>
              <input id="add_chapter_json" value="asdad" type="file" />

            </div>

        </div>

        <div class="centered">
        </div>

        <div id="logdownload" class="centered">
            <button onclick="Logger.download()">Download log data.</button>
        </div>
    </body>
</html>
